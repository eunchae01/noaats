<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<th:block th:fragment="content">

    <!-- Page Header -->
    <div class="page-header">
        <h2><i class="bi bi-graph-up me-2"></i>소비 패턴</h2>
        <p>최근 6개월간 소비 추이를 분석합니다</p>
    </div>

    <!-- Line Chart - Monthly Total -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-graph-up-arrow me-2"></i>월별 총지출 추이
        </div>
        <div class="card-body">
            <div class="chart-container" style="height: 300px;">
                <canvas id="monthlyTrendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Stacked Bar Chart - Category Trend -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="bi bi-bar-chart-steps me-2"></i>카테고리별 월별 지출
        </div>
        <div class="card-body">
            <div class="chart-container" style="height: 350px;">
                <canvas id="categoryTrendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Month-over-Month Comparison Table -->
    <div class="card">
        <div class="card-header">
            <i class="bi bi-arrow-left-right me-2"></i>전월 대비 변화
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th class="text-center">카테고리</th>
                            <th class="text-end" th:text="'전월 (' + ${prevDisplay} + ')'">전월</th>
                            <th class="text-end" th:text="'이번달 (' + ${currentDisplay} + ')'">이번달</th>
                            <th class="text-end">변화</th>
                            <th class="text-center">추이</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:if="${changes.isEmpty()}">
                            <td colspan="5">
                                <div class="empty-state">
                                    <div class="empty-icon"><i class="bi bi-bar-chart-line"></i></div>
                                    <p>비교할 지출 데이터가 없습니다</p>
                                </div>
                            </td>
                        </tr>
                        <tr th:each="c : ${changes}">
                            <td class="text-center">
                                <span class="badge badge-category"
                                      th:classappend="'badge-' + ${c.category.name().toLowerCase() == 'food' ? 'food' :
                                                     c.category.name().toLowerCase() == 'transport' ? 'transport' :
                                                     c.category.name().toLowerCase() == 'entertainment' ? 'entertainment' :
                                                     c.category.name().toLowerCase() == 'housing' ? 'housing' :
                                                     c.category.name().toLowerCase() == 'shopping' ? 'shopping' :
                                                     c.category.name().toLowerCase() == 'health' ? 'health' :
                                                     c.category.name().toLowerCase() == 'education' ? 'education' : 'other'}"
                                      th:text="${c.category.displayName}"></span>
                            </td>
                            <td class="text-end amount"
                                th:text="${#numbers.formatDecimal(c.prevAmount, 0, 'COMMA', 0, 'POINT')} + '원'"></td>
                            <td class="text-end amount"
                                th:text="${#numbers.formatDecimal(c.currentAmount, 0, 'COMMA', 0, 'POINT')} + '원'"></td>
                            <td class="text-end amount"
                                th:classappend="${c.increase} ? 'amount-negative' : (${c.decrease} ? 'amount-positive' : '')"
                                th:text="${(c.increase ? '+' : '') + #numbers.formatDecimal(c.change, 0, 'COMMA', 0, 'POINT')} + '원'"></td>
                            <td class="text-center">
                                <span th:if="${c.increase}" class="text-danger">
                                    <i class="bi bi-arrow-up-circle-fill"></i>
                                    <span th:text="'+' + ${#numbers.formatDecimal(c.changeRate, 1, 'POINT', 1, 'POINT')} + '%'"></span>
                                </span>
                                <span th:if="${c.decrease}" class="text-success">
                                    <i class="bi bi-arrow-down-circle-fill"></i>
                                    <span th:text="${#numbers.formatDecimal(c.changeRate, 1, 'POINT', 1, 'POINT')} + '%'"></span>
                                </span>
                                <span th:if="${c.neutral and !c.increase and !c.decrease}" class="text-secondary">
                                    <i class="bi bi-dash-circle-fill"></i>
                                    <span th:text="${#numbers.formatDecimal(c.changeRate, 1, 'POINT', 1, 'POINT')} + '%'"></span>
                                </span>
                            </td>
                        </tr>
                        <!-- Total Row -->
                        <tr class="table-active fw-bold">
                            <td class="text-center">합계</td>
                            <td class="text-end amount"
                                th:text="${#numbers.formatDecimal(totalChange.prevAmount, 0, 'COMMA', 0, 'POINT')} + '원'"></td>
                            <td class="text-end amount"
                                th:text="${#numbers.formatDecimal(totalChange.currentAmount, 0, 'COMMA', 0, 'POINT')} + '원'"></td>
                            <td class="text-end amount"
                                th:classappend="${totalChange.increase} ? 'amount-negative' : (${totalChange.decrease} ? 'amount-positive' : '')"
                                th:text="${(totalChange.increase ? '+' : '') + #numbers.formatDecimal(totalChange.change, 0, 'COMMA', 0, 'POINT')} + '원'"></td>
                            <td class="text-center">
                                <span th:if="${totalChange.increase}" class="text-danger">
                                    <i class="bi bi-arrow-up-circle-fill"></i>
                                    <span th:text="'+' + ${#numbers.formatDecimal(totalChange.changeRate, 1, 'POINT', 1, 'POINT')} + '%'"></span>
                                </span>
                                <span th:if="${totalChange.decrease}" class="text-success">
                                    <i class="bi bi-arrow-down-circle-fill"></i>
                                    <span th:text="${#numbers.formatDecimal(totalChange.changeRate, 1, 'POINT', 1, 'POINT')} + '%'"></span>
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</th:block>

<th:block th:fragment="scripts">
<script>
    // 월별 총지출 라인 차트
    fetch('/api/expenses/monthly-summary?months=6')
        .then(res => res.json())
        .then(data => {
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');

            // 라인 아래 그라데이션 fill
            const lineGrad = ctx.createLinearGradient(0, 0, 0, ctx.canvas.height);
            lineGrad.addColorStop(0, 'rgba(96, 165, 250, 0.25)');
            lineGrad.addColorStop(1, 'rgba(96, 165, 250, 0.02)');

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: '월별 총지출',
                        data: data.values,
                        borderColor: '#60A5FA',
                        backgroundColor: lineGrad,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointBackgroundColor: '#FFFFFF',
                        pointBorderColor: '#60A5FA',
                        pointBorderWidth: 3,
                        pointHoverRadius: 9,
                        pointHoverBackgroundColor: '#60A5FA',
                        pointHoverBorderColor: '#FFFFFF',
                        pointHoverBorderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(27, 42, 74, 0.92)',
                            padding: 12,
                            cornerRadius: 10,
                            callbacks: {
                                label: function(ctx) { return ' ' + ctx.parsed.y.toLocaleString() + '원'; }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: { callback: v => (v/10000) + '만원' },
                            grid: { color: 'rgba(0,0,0,0.04)' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        });

    // 카테고리별 월별 누적 막대 차트
    fetch('/api/expenses/category-trend?months=6')
        .then(res => res.json())
        .then(data => {
            const ctx = document.getElementById('categoryTrendChart').getContext('2d');

            // 각 dataset에 borderRadius + 투명도 추가
            data.datasets.forEach(ds => {
                ds.borderRadius = 4;
                ds.borderSkipped = false;
                // 기존 색상에 투명도 적용
                const hex = ds.backgroundColor;
                const r = parseInt(hex.slice(1,3), 16);
                const g = parseInt(hex.slice(3,5), 16);
                const b = parseInt(hex.slice(5,7), 16);
                ds.backgroundColor = 'rgba(' + r + ',' + g + ',' + b + ', 0.75)';
                ds.hoverBackgroundColor = hex;
            });

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: data.datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { usePointStyle: true, pointStyleWidth: 10, font: { size: 11 }, padding: 14 }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(27, 42, 74, 0.92)',
                            padding: 12,
                            cornerRadius: 10,
                            callbacks: {
                                label: function(ctx) { return ' ' + ctx.dataset.label + ': ' + ctx.parsed.y.toLocaleString() + '원'; }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: {
                            stacked: true,
                            ticks: { callback: v => (v/10000) + '만원' },
                            grid: { color: 'rgba(0,0,0,0.04)' }
                        }
                    }
                }
            });
        });
</script>
</th:block>

</html>
